---
title: "Week 12 - The Office"
author: "Emily Darling"
date: "16/03/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)

options(scipen=999)
```

#Load data

```{rget-data}
# Get the Data 

office_ratings <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-17/office_ratings.csv')

# Or read in with tidytuesdayR package (https://github.com/thebioengineer/tidytuesdayR)
# PLEASE NOTE TO USE 2020 DATA YOU NEED TO USE tidytuesdayR version ? from GitHub

# Either ISO-8601 date or year/week works!

# Install via 
# devtools::install_github("thebioengineer/tidytuesdayR")
# 
# tuesdata <- tidytuesdayR::tt_load('2020-03-17')
# tuesdata <- tidytuesdayR::tt_load(2020, week = 12)
# 
# 
# office_ratings <- tuesdata$office_ratings

office_ratings

#install.packages("schrute")
library(schrute)

dialogue <- schrute::theoffice %>% 
  clean_names() %>% 
  as_tibble()
```

#Explore data

```{r explore}
office_ratings
dialogue

dialogue %>% 
  tabyl(character) %>% 
  arrange(-n) %>% 
  slice(1:10)

dialogue %>% 
  filter(character == "Pam") %>% 
  distinct(text)


head(dialogue$text_w_direction)
head(dialogue$text)

dialogue_token <- dialogue %>%
  tidytext::unnest_tokens(word, text)

dialogue_token
```


Ideas for data visualization

* How many words do the top characters speak, is there a difference by gender? 
* Does this change over seasons? 
* Per episode, how is the number of words spoken by female characters associated with rating?

First, subset to top 10 characters that speak the most words on the entire show. And add gender.

```{r find-top10-add-gender}

#Choose top 10 characters with most words
#Dialogue is 'tokenized'- each line is a word
top10_chars <- dialogue %>% 
  tabyl(character) %>% 
  arrange(-n) %>% 
  slice(1:10) %>% 
  pull(character)

#Set gender for each character
top10_gender <- c("m", "m", "m", "f", "m", "f", "m", "f", "m", "m")
top10_gender
 
#Make KEY for character and gender
top10_chars <- as_tibble(top10_chars) %>% 
  cbind(top10_gender) %>% 
    rename("character" = value, 
           "gender" = top10_gender) %>% 
  mutate(gender = case_when(
    gender == "m" ~ "Male", 
    TRUE ~ "Female"))

top10_chars

#Filter words to top 10 characters, and join gender to dataset
dialogue_top10 <- dialogue %>% 
  filter(character %in% top10_chars$character) %>% 
  left_join(top10_chars)

unique(dialogue_top10$character)
dialogue_top10
  
```

Next, join in ratings and season date

```{r join-ratings}
office_ratings
str(office_ratings)

str(dialogue_top10)

dialogue_top10 <- dialogue_top10 %>% 
  mutate(season = as.numeric(season), 
         episode = as.numeric(episode)) %>% 
  left_join(office_ratings, 
            by = c("season", "episode"))

dialogue_top10

```


Now, sum words by character and by episode

```{r sum-words}

data <- dialogue_top10 %>% 
  group_by(season, 
           episode, 
           air_date, 
           imdb_rating, 
           character, 
           gender) %>% 
  count() %>% 
  ungroup() %>% 
  group_by(season, 
           episode) %>% 
  mutate(total_words = sum(n), 
         prop_words = n / total_words) %>% 
  ungroup() %>% 
  group_by(season, 
           episode, 
           air_date, 
           imdb_rating, 
           gender) %>% 
  slice(1:2) %>% #slice by top 2 female and top 2 males
  arrange(season, 
          episode, 
          gender)

data

```

Some plots

```{r plots}
#overall be gender, across all seasons
ggplot(data = data,
       aes(x = gender, y= prop_words)) + 
  geom_boxplot(aes(fill = gender))

summary <- data %>% 
  group_by(episode, gender) %>% 
  summarize(mean = mean(prop_words)) %>% 
  group_by(gender) %>% 
  summarize(mean = mean(mean))

summary

#top 2 female characters speak 46% of words that top 2 men speak in the Office, averaged over all seasons
summary$mean[1] / summary$mean[2]* 100 

#over season
summary_season <- data %>% 
  group_by(season, episode, gender) %>% 
  summarize(mean = mean(prop_words)) %>% 
  group_by(season, gender) %>% 
  summarize(mean = mean(mean)) 

summary_season

ggplot(data = summary_season, 
       aes(x = as.factor(season), y = mean, group = gender)) +
  geom_point(aes(colour =  gender), 
             size = 2) +
  geom_line(aes(colour = gender), size = 1) +
  theme_minimal(base_size = 16) + 
  xlab("Season") + 
  ylab("Mean proportion of words spoken by top 2 characters")



```



